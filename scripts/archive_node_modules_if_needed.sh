archive_if_needed () {
    # Compress without timestamps, so that identical `node_modules` will produce identical tarballs
    #(find node_modules/ -print0 | sort -z | safe_tar cf  --no-recursion --null -T --mtime='UTC 1970-01-01' | gzip -n) &&

    gnu_tar --sort=name --owner=root:0 --group=root:0 --mtime='UTC 2019-01-01' --to-stdout node_modules | gzip -n --stdout > node_modules_backup/node_modules.tar.gz

    git config --global user.name 'GitHub Actions Bot' &&
    git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com' &&
    git add . &&

    # The commit operation is permitted to fail because it's possible
    # that no changes were made to `node_modules`.
    (git commit -am "Backup node_modules"; true) &&

    # Since we're not using a PAT, we can safely push without
    # (recursively) triggering the deploy job.
    git push
}

if tar --mtime='UTC 2019-01-01' /dev/null node_modules; then
  alias gnu_tar="tar"
else
  brew install gnu-tar;
  alias gnu_tar="gtar"
fi

echo "GNU TAR: $(safe_tar --version)"

archive_if_needed